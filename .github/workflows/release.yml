name: Build & Release

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      # 1. CHECKOUT
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2. SETUP
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      # 3. FIX ICON ISSUE BEFORE BUILDING
      - name: Fix icon configuration
        run: |
          # Remove icon references from electron-builder.yml to prevent errors
          if [ -f "electron-builder.yml" ]; then
            sed -i 's/.*icon.*public\/icon\.ico.*//g' electron-builder.yml
            sed -i 's/.*icon.*public\/icon\.icns.*//g' electron-builder.yml
            sed -i 's/.*installerIcon.*//g' electron-builder.yml
            sed -i 's/.*uninstallerIcon.*//g' electron-builder.yml
            sed -i 's/.*installerHeaderIcon.*//g' electron-builder.yml
            echo "Removed icon references from electron-builder.yml"
          fi
        shell: bash

      # 4. BUMP VERSION (SIMPLIFIED)
      - name: Bump version
        id: bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Simple version bump
          NEW_VERSION=$(npm version patch -m "Release v%s [skip ci]")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version bumped to: $NEW_VERSION"
        shell: bash

      # 5. BUILD
      - name: Build the app
        run: npm run build
        shell: bash

      # 6. PACKAGE
      - name: Package for distribution
        run: npm run dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash

      # 7. CHECK BUILT FILES (FIXED)
      - name: Check built files
        run: |
          echo "=== Built files in release/ ==="
          if [ -d "release" ]; then
            echo "Files found:"
            ls -la release/
            echo ""
            echo "All files recursively:"
            find release -type f 2>/dev/null || echo "No files found"
          else
            echo "No release directory found"
          fi
        shell: bash

      # 8. PUSH TAG
      - name: Push tag to GitHub
        run: |
          TAG="${{ steps.bump.outputs.new_version }}"
          echo "Pushing tag: $TAG"
          git push origin $TAG
        shell: bash

      # 9. CREATE RELEASE (SIMPLIFIED - USING BASH)
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.bump.outputs.new_version }}
        run: |
          echo "=== Creating release for $TAG ==="

          # Wait for tag to propagate
          sleep 3

          # Create release
          gh release create "$TAG" \
            --title "Release $TAG" \
            --generate-notes

          echo "=== Uploading files ==="

          # Upload all .exe files
          echo "Uploading EXE files..."
          find release -name "*.exe" -type f 2>/dev/null | while read -r file; do
            echo "Uploading: $(basename "$file")"
            gh release upload "$TAG" "$file" --clobber || echo "Failed to upload: $file"
          done

          # Upload all .yml files (for auto-updates)
          echo "Uploading YML files..."
          find release -name "*.yml" -type f 2>/dev/null | while read -r file; do
            echo "Uploading: $(basename "$file")"
            gh release upload "$TAG" "$file" --clobber || echo "Failed to upload: $file"
          done

          # Upload all .blockmap files
          echo "Uploading blockmap files..."
          find release -name "*.blockmap" -type f 2>/dev/null | while read -r file; do
            echo "Uploading: $(basename "$file")"
            gh release upload "$TAG" "$file" --clobber || echo "Failed to upload: $file"
          done

          echo "=== Upload complete ==="
        shell: bash

      # 10. PUSH VERSION COMMIT
      - name: Push version commit to main
        run: |
          echo "Pushing version bump to main..."
          git push origin main
        shell: bash

      # 11. SYNC DEVELOPMENT BRANCH (Optional - Simplified)
      - name: Sync development branch
        if: success()
        run: |
          echo "=== Checking development branch ==="

          # Check if development branch exists
          if git ls-remote --heads origin development | grep -q development; then
            echo "Development branch exists, syncing..."
            git fetch origin development
            git checkout development
            git merge main --no-edit
            git push origin development
            echo "Development branch synced"
          else
            echo "No development branch found, skipping"
          fi

          # Return to main
          git checkout main
        shell: bash
