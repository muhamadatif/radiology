name: Build & Release

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      # 1. CHECKOUT
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2. SETUP
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      # 3. BUMP VERSION (FIXED FOR POWERSHELL)
      - name: Bump version
        id: bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Get current version
          $CURRENT_VERSION = node -p "require('./package.json').version"
          echo "Current version: $CURRENT_VERSION"

          # Bump version
          $NEW_VERSION = npm version patch -m "chore(release): v%s [skip ci]"
          $CLEAN_VERSION = $NEW_VERSION.Substring(1)  # Remove 'v' prefix

          echo "new_version=$NEW_VERSION" >> $env:GITHUB_OUTPUT
          echo "clean_version=$CLEAN_VERSION" >> $env:GITHUB_OUTPUT
          echo "Version bumped to: $NEW_VERSION"
        shell: pwsh # Explicitly use PowerShell

      # 4. BUILD
      - name: Build the app
        run: npm run build

      # 5. PACKAGE
      - name: Package for distribution
        run: npm run dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6. DEBUG - See what was built
      - name: List built files
        run: |
          echo "=== Built files in release/ ==="
          dir release /s /b 2>nul || echo "No files found"
        shell: pwsh

      # 7. PUSH TAG
      - name: Push tag to GitHub
        run: |
          $TAG = "${{ steps.bump.outputs.new_version }}"
          echo "Pushing tag: $TAG"
          git push origin $TAG
        shell: pwsh

      # 8. CREATE RELEASE (POWERSHELL VERSION)
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.bump.outputs.new_version }}
        run: |
          echo "=== Creating release for $env:TAG ==="

          # Wait for tag to propagate
          Start-Sleep -Seconds 3

          # Create release
          gh release create "$env:TAG" `
            --title "Release $env:TAG" `
            --generate-notes

          echo "=== Uploading files ==="

          # Upload installer (.exe)
          echo "Looking for installer..."
          Get-ChildItem -Path "release" -Filter "*.exe" -File | ForEach-Object {
            echo "Uploading installer: $($_.Name)"
            gh release upload "$env:TAG" "$($_.FullName)" --clobber
          }

          # Upload blockmap and YML files
          echo "Looking for update files..."
          $patterns = @("*.blockmap", "*.yml", "*.zip")
          foreach ($pattern in $patterns) {
            Get-ChildItem -Path "release" -Filter $pattern -File | ForEach-Object {
              echo "Uploading: $($_.Name)"
              gh release upload "$env:TAG" "$($_.FullName)" --clobber
            }
          }

          # Upload any other files
          echo "Checking for other files..."
          Get-ChildItem -Path "release" -File | Where-Object {
            $_.Extension -notin @('.exe', '.blockmap', '.yml', '.zip')
          } | ForEach-Object {
            echo "Uploading additional file: $($_.Name)"
            gh release upload "$env:TAG" "$($_.FullName)" --clobber
          }

          echo "=== Upload complete ==="
        shell: pwsh

      # 9. PUSH VERSION COMMIT
      - name: Push version commit to main
        run: |
          echo "Pushing version bump to main..."
          git push origin main
        shell: pwsh

      # 10. SYNC DEVELOPMENT BRANCH (Optional)
      - name: Sync development branch
        if: success()
        run: |
          echo "=== Checking development branch ==="

          # Check if development branch exists
          $hasDevBranch = git ls-remote --heads origin development
          if ($hasDevBranch) {
            echo "Development branch exists, syncing..."
            git fetch origin development
            git checkout development
            git merge main --no-edit
            git push origin development
            echo "Development branch synced"
          } else {
            echo "No development branch found, skipping"
          }

          # Return to main
          git checkout main
        shell: pwsh
