name: Build & Release

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      # 1. CHECKOUT
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2. SETUP
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      # 3. BUMP VERSION
      - name: Bump version
        id: bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Get current version
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"

          # Bump version
          NEW_VERSION=$(npm version patch -m "chore(release): v%s [skip ci]")
          CLEAN_VERSION=${NEW_VERSION:1}

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "Version bumped to: $NEW_VERSION"

      # 4. BUILD
      - name: Build the app
        run: npm run build

      # 5. PACKAGE
      - name: Package for distribution
        run: npm run dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6. DEBUG - See what was built
      - name: List built files
        run: |
          echo "=== Built files in release/ ==="
          find release/ -type f -name "*" 2>/dev/null | head -20 || echo "No files found"
          echo ""
          echo "=== Directory structure ==="
          ls -la release/ || echo "No release directory"

      # 7. PUSH TAG
      - name: Push tag to GitHub
        run: |
          TAG="${{ steps.bump.outputs.new_version }}"
          echo "Pushing tag: $TAG"
          git push origin $TAG

      # 8. CREATE RELEASE
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.bump.outputs.new_version }}
        run: |
          echo "=== Creating release for $TAG ==="

          # Wait for tag to propagate
          sleep 3

          # Create release
          gh release create "$TAG" \
            --title "Release $TAG" \
            --generate-notes

          echo "=== Uploading files ==="

          # Upload installer (.exe)
          echo "Looking for installer..."
          for file in release/*.exe; do
            if [ -f "$file" ]; then
              echo "Uploading installer: $(basename "$file")"
              gh release upload "$TAG" "$file" --clobber
            fi
          done

          # Upload blockmap and YML files (for auto-updates)
          echo "Looking for update files..."
          for pattern in "release/*.blockmap" "release/*.yml" "release/*.zip"; do
            for file in $pattern; do
              if [ -f "$file" ]; then
                echo "Uploading: $(basename "$file")"
                gh release upload "$TAG" "$file" --clobber
              fi
            done
          done

          # Also check for any other files
          echo "Checking for other files..."
          for file in release/*; do
            if [ -f "$file" ] && [[ ! "$file" == *.exe ]] && [[ ! "$file" == *.blockmap ]] && [[ ! "$file" == *.yml ]]; then
              echo "Uploading additional file: $(basename "$file")"
              gh release upload "$TAG" "$file" --clobber
            fi
          done

          echo "=== Upload complete ==="

      # 9. PUSH VERSION COMMIT
      - name: Push version commit to main
        run: |
          echo "Pushing version bump to main..."
          git push origin main

      # 10. SYNC DEVELOPMENT BRANCH (Optional)
      - name: Sync development branch
        if: success()
        run: |
          echo "=== Checking development branch ==="

          # Check if development branch exists
          if git ls-remote --heads origin development | grep -q development; then
            echo "Development branch exists, syncing..."
            git fetch origin development
            git checkout development
            git merge main --no-edit
            git push origin development
            echo "Development branch synced"
          else
            echo "No development branch found, skipping"
          fi

          # Return to main
          git checkout main
